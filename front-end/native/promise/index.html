<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link
      rel="stylesheet"
      href="/data-structure-and-algorithms-guidebook/umi.css"
    />
    <script>
      window.routerBase = "/data-structure-and-algorithms-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.22
    </script>
    <title>Promise</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/data-structure-and-algorithms-favicon.svg&#x27;)" href="/data-structure-and-algorithms-guidebook//">Data Structure and Algorithms Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/data-structure-and-algorithms-guidebook//data-structure">数据结构</a><a href="/data-structure-and-algorithms-guidebook//algorithms">算法</a><a href="/data-structure-and-algorithms-guidebook//leetcode">LeetCode</a><a aria-current="page" class="active" href="/data-structure-and-algorithms-guidebook//front-end">前端编程</a><a href="/data-structure-and-algorithms-guidebook//extensions">扩展</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/data-structure-and-algorithms-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/data-structure-and-algorithms-favicon.svg&#x27;)" href="/data-structure-and-algorithms-guidebook//"></a><h1>Data Structure and Algorithms Guidebook</h1><p>数据结构与算法完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/data-structure-and-algorithms-guidebook//data-structure">数据结构</a></li><li><a href="/data-structure-and-algorithms-guidebook//algorithms">算法</a></li><li><a href="/data-structure-and-algorithms-guidebook//leetcode">LeetCode</a></li><li><a aria-current="page" class="active" href="/data-structure-and-algorithms-guidebook//front-end">前端编程</a></li><li><a href="/data-structure-and-algorithms-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/data-structure-and-algorithms-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/data-structure-and-algorithms-guidebook//front-end">前端编程</a></li><li><a aria-current="page" class="active" href="/data-structure-and-algorithms-guidebook//front-end/native">原生编程</a><ul><li><a href="/data-structure-and-algorithms-guidebook//front-end/native/string"><span>字符串 API</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/native/array"><span>数组 API</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/native/object"><span>对象 API</span></a></li><li><a aria-current="page" class="active" href="/data-structure-and-algorithms-guidebook//front-end/native/promise"><span>Promise</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/native/event"><span>事件处理</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/native/json-stringify"><span>JSON</span></a></li></ul></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils">实用工具</a><ul><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/array"><span>数组方法</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/string"><span>字符串方法</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/regexp"><span>正则表达式</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/asynchronous"><span>异步编程</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/design-patterns"><span>设计模式</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/dom"><span>DOM</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/feature"><span>功能实现</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/function"><span>函数</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/number"><span>数学</span></a></li><li><a href="/data-structure-and-algorithms-guidebook//front-end/utils/object"><span>对象</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="promise"><a aria-hidden="true" href="#promise"><span class="icon icon-link"></span></a>Promise</h1><p>简单 Promise 粗糙实现，关键点在于：</p><ol><li>当 <code>pending</code> 时，<code>thenable</code> 函数由一个队列维护</li><li>当状态变为 <code>resolveed(fulfilled)</code> 时，队列中所有 <code>thenable</code> 函数执行</li><li>当 <code>resolved</code> 时，<code>thenable</code> 函数直接执行</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="/**
 * 参考：https://juejin.im/post/6856213486633304078
 */

const STATUS = {
  PENDING: &#x27;PENDING&#x27;,
  FULFILLED: &#x27;FULFILLED&#x27;,
  REJECTED: &#x27;REJECTED&#x27;
}

function Promise (executor) {
  let self = this
  this.status = STATUS.PENDING
  this.value = null
  this.reason = null
  this.onFulfilledHandlers = []
  this.onRejectionHandlers = []

  function resolve (value) {
    if (self.status === STATUS.PENDING) {
      self.status = STATUS.FULFILLED
      self.value = value

      self.onFulfilledHandlers.forEach((handler) =&gt; handler(self.value))
    }
  }

  function reject (reason) {
    if (self.status === STATUS.PENDING) {
      self.status = STATUS.REJECTED
      self.reason = reason

      self.onRejectionHandlers.forEach((handler) =&gt; handler(self.reason))
    }
  }

  try {
    executor(resolve, reject)
  } catch (err) {
    reject(err)
  }
}

// promise 是要返回的 Promise 实例
// x 是 onFulfilled / onRejected 的返回结果
function resolvePromise (promise, x, resolve, reject) {
  // 如果 promise 和 x 指向同一对象，以 TypeError 为据因拒绝执行 promise
  // 这是为了防止死循环
  if (promise === x) {
    return reject(new TypeError(&#x27;The promise and the return value are the same&#x27;))
  }

  if (x instanceof Promise) {
    // 如果 x 为 Promise ，则使 promise 接受 x 的状态
    // 也就是继续执行 x，如果执行的时候拿到一个 y，还要继续解析 y
    // 这个 if 跟下面判断 then 然后拿到执行其实重复了，可有可无
    x.then(function (y) {
      resolvePromise(promise, y, resolve, reject)
    }, reject)

  } else if (typeof x === &#x27;object&#x27; || typeof x === &#x27;function&#x27;) {
    // 如果 x 为 null，应该直接返回 resolve
    if (x === null) {
      return resolve(x)
    }

    let then = null
    try {
      // 这里要用 var（坑死）
      // 把 x.then 赋值为 then
      then = x.then
    } catch (err) {
      // 如果取 x.then 的值时抛出 err，则以 err 为拒因决绝 Promise
      return reject(err)
    }

    // 如果 then 是函数
    if (typeof then === &#x27;function&#x27;) {
      let called = false

      // 将 x 作为函数作用域 this 调用之
      // 传递两个回调函数作为参数，第一个参数叫做 resolvePromise，第二个参数叫做 rejectPromise
      try {
        then.call(
          x,
          // 如果 resolvePromise 以值 y 为参数被调用，则运行 [[Resolve]](promise, y)
          function (y) {
            // 如果 resolvePromise 和 rejectPromise 均被调用
            // 或者同一参数调用多次，则优先采用首次调用并忽略剩下的调用
            // 实现这条需要前面加一个变量 called
            if (called) return
            called = true
            resolvePromise(promise, y, resolve, reject)
          },
          // 如果 rejectPromise 以拒因 r 为参数被调用，则以拒因 r 拒绝 promise
          function (r) {
            if (called) return
            called = true
            reject(r)
          }
        )
      } catch (err) {
        // 如果调用 then 方法抛出了异常 err
        // 如果 resolvePromise 或 rejectPromise 已经被调用，则忽略之
        if (called) return

        reject(err)
      }
    } else {
      // 如果 then 不是函数，以 x 参数执行 Promise
      resolve(x)
    }
  } else {
    // 如果 x 不为对象或者函数，以 x 为参数执行 resolve
    resolve(x)
  }
}

Promise.prototype.then = function (onFulfilled, onRejected) {
  const self = this
  const onFulfillment = typeof onFulfilled === &#x27;function&#x27; ? onFulfilled : value =&gt; value
  const onRejection = typeof onRejected === &#x27;function&#x27; ? onRejected : reason =&gt; { throw reason }

  let returnPromise = new Promise(function (resolve, reject) {

    function handler (flag) {
      const condition = flag === STATUS.FULFILLED ? onFulfilled : onRejected
      const callback = flag === STATUS.FULFILLED ? onFulfillment : onRejection
      const param = flag === STATUS.FULFILLED ? self.value : self.reason

      setTimeout(function () {
        try {
          if (typeof condition === &#x27;function&#x27;) {
            let x = callback(param)
            resolvePromise(returnPromise, x, resolve, reject)
          } else {
            flag === STATUS.FULFILLED ? resolve(param) : reject(param)
          }
        } catch (err) {
          reject(err)
        }
      }, 0)
    }

    if (self.status === STATUS.PENDING) {
      // Promise 当前状态还是 Pending，将回调函数保存起来
      self.onFulfilledHandlers.push(function () {
        handler(STATUS.FULFILLED)
      })
      self.onRejectionHandlers.push(function () {
        handler(STATUS.REJECTED)
      })
    } else if (self.status === STATUS.FULFILLED) {
      handler(STATUS.FULFILLED)
    } else {
      handler(STATUS.REJECTED)
    }
  })

  return returnPromise
}

Promise.prototype.catch = function (onRejection) {
  this.then(null, onRejection)
}

Promise.prototype.finally = function (fn) {
  return this.then(function (value) {
    return Promise.resolve(fn()).then(function () {
      return value
    })
  }, function (err) {
    return Promise.reject(fn()).then(function () {
      return err
    })
  })
}

Promise.resolve = function (value) {
  if (value instanceof Promise) {
    return value
  }

  return new Promise(function (resolve) {
    resolve(value)
  })
}

// 返回指定 reason 失败态的 Promise 对象
Promise.reject = function (reason) {
  return new Promise((resolve, reject) =&gt; {
    reject(reason)
  })
}

// 返回一个 Promise 对象，只有当所有 Promise 都成功时返回的 Promise 状态才成功
Promise.all = function (iterable) {
  const values = new Array(iterable.length)
  // 状态为 fulfilled 的 Promise 的数量
  let resolvedCount = 0

  return new Promise((resolve, reject) =&gt; {
    // 遍历 iterable，获取每个 Promise 的结果
    iterable.forEach((promise, index) =&gt; {
      Promise.resolve(promise).then(
        value =&gt; {
          resolvedCount++
          values[index] = value

          // 如果全部 Promise 都为 fulfilled 状态，return 的 Promise 状态为 fulfilled
          if (resolvedCount === iterable.length) {
            resolve(values)
          }
        },
        reason =&gt; {
          // 只要有一个失败，return 的 Promise 状态就为 reject
          reject(reason)
        }
      )
    })
  })
}

// 返回一个 Promise 对象，
Promise.race = function (iterable) {
  return new Promise((resolve, reject) =&gt; {
    // 遍历数组，获取每个 Promise 的结果
    iterable.forEach((item, index) =&gt; {
      Promise.resolve(item).then(
        value =&gt; {
          resolve(value)
        },
        reason =&gt; {
          reject(reason)
        }
      )
    })
  })
}

Promise.allSettled = function (iterable) {
  return new Promise(function (resolve, reject) {
    const len = iterable.length
    let result = []
    let resolveCount = 0

    if (length === 0) {
      return resolve(result)
    } else {
      for (let i = 0; i &lt; len; i++) {
        (function (i) {
          const currentPromise = Promise.resolve(iterable[i])

          currentPromise.then(function (value) {
            resolveCount++
            result[i] = {
              status: STATUS.FULFILLED,
              value: value
            }

            if (resolveCount === len) {
              return resolve(result)
            }
          }, function (reason) {
            resolveCount++
            result[i] = {
              status: STATUS.REJECTED,
              reason: reason
            }
            if (count === len) {
              return resolve(result)
            }
          })
        })(i)
      }
    }
  })
}

Promise.deferred = function () {
  var result = {}

  result.promise = new Promise(function (resolve, reject) {
    result.resolve = resolve
    result.reject = reject
  })

  return result
}

module.exports = Promise

" data-status="copy"></button><div class="token-line"><span class="token doc-comment comment">/**</span></div><div class="token-line"><span class="token doc-comment comment"> * 参考：https://juejin.im/post/6856213486633304078</span></div><div class="token-line"><span class="token doc-comment comment"> */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">PENDING</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;PENDING&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">FULFILLED</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;FULFILLED&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">REJECTED</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;REJECTED&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> self </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onFulfilledHandlers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onRejectionHandlers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">onFulfilledHandlers</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reject</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reason</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">onRejectionHandlers</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// promise 是要返回的 Promise 实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// x 是 onFulfilled / onRejected 的返回结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolvePromise</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> x</span><span class="token parameter punctuation">,</span><span class="token parameter"> resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果 promise 和 x 指向同一对象，以 TypeError 为据因拒绝执行 promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 这是为了防止死循环</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise </span><span class="token operator">===</span><span class="token plain"> x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#x27;The promise and the return value are the same&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 x 为 Promise ，则使 promise 接受 x 的状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 也就是继续执行 x，如果执行的时候拿到一个 y，还要继续解析 y</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 这个 if 跟下面判断 then 然后拿到执行其实重复了，可有可无</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    x</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">,</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> x </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;object&#x27;</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> x </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 x 为 null，应该直接返回 resolve</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> then </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 这里要用 var（坑死）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 把 x.then 赋值为 then</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      then </span><span class="token operator">=</span><span class="token plain"> x</span><span class="token punctuation">.</span><span class="token property-access">then</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如果取 x.then 的值时抛出 err，则以 err 为拒因决绝 Promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 then 是函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> then </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> called </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 将 x 作为函数作用域 this 调用之</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 传递两个回调函数作为参数，第一个参数叫做 resolvePromise，第二个参数叫做 rejectPromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        then</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          x</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 如果 resolvePromise 以值 y 为参数被调用，则运行 [[Resolve]](promise, y)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 如果 resolvePromise 和 rejectPromise 均被调用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 或者同一参数调用多次，则优先采用首次调用并忽略剩下的调用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 实现这条需要前面加一个变量 called</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">called</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            called </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">,</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 如果 rejectPromise 以拒因 r 为参数被调用，则以拒因 r 拒绝 promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">called</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            called </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">r</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 如果调用 then 方法抛出了异常 err</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 如果 resolvePromise 或 rejectPromise 已经被调用，则忽略之</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">called</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如果 then 不是函数，以 x 参数执行 Promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 x 不为对象或者函数，以 x 为参数执行 resolve</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">then</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> onRejected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> self </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> onFulfillment </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> onFulfilled </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function">onFulfilled</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> onRejection </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> onRejected </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function">onRejected</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">throw</span><span class="token plain"> reason </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> returnPromise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handler</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> condition </span><span class="token operator">=</span><span class="token plain"> flag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> onFulfilled </span><span class="token punctuation">:</span><span class="token plain"> onRejected</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> callback </span><span class="token operator">=</span><span class="token plain"> flag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> onFulfillment </span><span class="token punctuation">:</span><span class="token plain"> onRejection</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> param </span><span class="token operator">=</span><span class="token plain"> flag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> self</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> self</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> condition </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">let</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token plain">param</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token plain">returnPromise</span><span class="token punctuation">,</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            flag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">param</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">param</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// Promise 当前状态还是 Pending，将回调函数保存起来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">onFulfilledHandlers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      self</span><span class="token punctuation">.</span><span class="token property-access">onRejectionHandlers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> returnPromise</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">catch</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">onRejection</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> onRejection</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">finally</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> err</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">value </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 返回指定 reason 失败态的 Promise 对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">reason</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 返回一个 Promise 对象，只有当所有 Promise 都成功时返回的 Promise 状态才成功</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">all</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">iterable</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> values </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token plain">iterable</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 状态为 fulfilled 的 Promise 的数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> resolvedCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 遍历 iterable，获取每个 Promise 的结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    iterable</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          resolvedCount</span><span class="token operator">++</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          values</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 如果全部 Promise 都为 fulfilled 状态，return 的 Promise 状态为 fulfilled</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedCount </span><span class="token operator">===</span><span class="token plain"> iterable</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">values</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 只要有一个失败，return 的 Promise 状态就为 reject</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">reason</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 返回一个 Promise 对象，</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">race</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">iterable</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 遍历数组，获取每个 Promise 的结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    iterable</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">reason</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">allSettled</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">iterable</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> len </span><span class="token operator">=</span><span class="token plain"> iterable</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> resolveCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">length </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> len</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> currentPromise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">iterable</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">          currentPromise</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            resolveCount</span><span class="token operator">++</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            result</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              status</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              value</span><span class="token punctuation">:</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveCount </span><span class="token operator">===</span><span class="token plain"> len</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            resolveCount</span><span class="token operator">++</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            result</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              status</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              reason</span><span class="token punctuation">:</span><span class="token plain"> reason</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> len</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">deferred</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  result</span><span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    result</span><span class="token punctuation">.</span><span class="token property-access">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> resolve</span></div><div class="token-line"><span class="token plain">    result</span><span class="token punctuation">.</span><span class="token property-access">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reject</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> result</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><a href="https://juejin.im/post/5e8bec156fb9a03c4d40f4bc" target="_blank" rel="noopener noreferrer">手写一个 Promise/A+，完美通过官方 872 个测试用例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/leetcode/edit/master/docs/front-end/native/promise.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/23/2020, 1:03:06 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/data-structure-and-algorithms-guidebook/umi.js"></script>
    <script src="/data-structure-and-algorithms-guidebook/docs__front-end__native__promise.md.js"></script>
  </body>
</html>
