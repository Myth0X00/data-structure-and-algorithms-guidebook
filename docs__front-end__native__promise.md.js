(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[67],{"7caF":function(e,n,r){"use strict";r.r(n);var t=r("q1tI"),l=r.n(t),o=(r("B2uJ"),r("+su7"),r("qOys")),s=r.n(o);r("5Yjd");n["default"]=function(){return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("h1",{id:"promise"},l.a.createElement("a",{"aria-hidden":"true",href:"#promise"},l.a.createElement("span",{className:"icon icon-link"})),"Promise"),l.a.createElement("p",null,"\u7b80\u5355 Promise \u7c97\u7cd9\u5b9e\u73b0\uff0c\u5173\u952e\u70b9\u5728\u4e8e\uff1a"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u5f53 ",l.a.createElement("code",null,"pending")," \u65f6\uff0c",l.a.createElement("code",null,"thenable")," \u51fd\u6570\u7531\u4e00\u4e2a\u961f\u5217\u7ef4\u62a4"),l.a.createElement("li",null,"\u5f53\u72b6\u6001\u53d8\u4e3a ",l.a.createElement("code",null,"resolveed(fulfilled)")," \u65f6\uff0c\u961f\u5217\u4e2d\u6240\u6709 ",l.a.createElement("code",null,"thenable")," \u51fd\u6570\u6267\u884c"),l.a.createElement("li",null,"\u5f53 ",l.a.createElement("code",null,"resolved")," \u65f6\uff0c",l.a.createElement("code",null,"thenable")," \u51fd\u6570\u76f4\u63a5\u6267\u884c")),l.a.createElement(s.a,{code:"/**\n * \u53c2\u8003\uff1ahttps://juejin.im/post/6856213486633304078\n */\n\nconst STATUS = {\n  PENDING: 'PENDING',\n  FULFILLED: 'FULFILLED',\n  REJECTED: 'REJECTED'\n}\n\nfunction Promise (executor) {\n  let self = this\n  this.status = STATUS.PENDING\n  this.value = null\n  this.reason = null\n  this.onFulfilledHandlers = []\n  this.onRejectionHandlers = []\n\n  function resolve (value) {\n    if (self.status === STATUS.PENDING) {\n      self.status = STATUS.FULFILLED\n      self.value = value\n\n      self.onFulfilledHandlers.forEach((handler) => handler(self.value))\n    }\n  }\n\n  function reject (reason) {\n    if (self.status === STATUS.PENDING) {\n      self.status = STATUS.REJECTED\n      self.reason = reason\n\n      self.onRejectionHandlers.forEach((handler) => handler(self.reason))\n    }\n  }\n\n  try {\n    executor(resolve, reject)\n  } catch (err) {\n    reject(err)\n  }\n}\n\n// promise \u662f\u8981\u8fd4\u56de\u7684 Promise \u5b9e\u4f8b\n// x \u662f onFulfilled / onRejected \u7684\u8fd4\u56de\u7ed3\u679c\nfunction resolvePromise (promise, x, resolve, reject) {\n  // \u5982\u679c promise \u548c x \u6307\u5411\u540c\u4e00\u5bf9\u8c61\uff0c\u4ee5 TypeError \u4e3a\u636e\u56e0\u62d2\u7edd\u6267\u884c promise\n  // \u8fd9\u662f\u4e3a\u4e86\u9632\u6b62\u6b7b\u5faa\u73af\n  if (promise === x) {\n    return reject(new TypeError('The promise and the return value are the same'))\n  }\n\n  if (x instanceof Promise) {\n    // \u5982\u679c x \u4e3a Promise \uff0c\u5219\u4f7f promise \u63a5\u53d7 x \u7684\u72b6\u6001\n    // \u4e5f\u5c31\u662f\u7ee7\u7eed\u6267\u884c x\uff0c\u5982\u679c\u6267\u884c\u7684\u65f6\u5019\u62ff\u5230\u4e00\u4e2a y\uff0c\u8fd8\u8981\u7ee7\u7eed\u89e3\u6790 y\n    // \u8fd9\u4e2a if \u8ddf\u4e0b\u9762\u5224\u65ad then \u7136\u540e\u62ff\u5230\u6267\u884c\u5176\u5b9e\u91cd\u590d\u4e86\uff0c\u53ef\u6709\u53ef\u65e0\n    x.then(function (y) {\n      resolvePromise(promise, y, resolve, reject)\n    }, reject)\n\n  } else if (typeof x === 'object' || typeof x === 'function') {\n    // \u5982\u679c x \u4e3a null\uff0c\u5e94\u8be5\u76f4\u63a5\u8fd4\u56de resolve\n    if (x === null) {\n      return resolve(x)\n    }\n\n    let then = null\n    try {\n      // \u8fd9\u91cc\u8981\u7528 var\uff08\u5751\u6b7b\uff09\n      // \u628a x.then \u8d4b\u503c\u4e3a then\n      then = x.then\n    } catch (err) {\n      // \u5982\u679c\u53d6 x.then \u7684\u503c\u65f6\u629b\u51fa err\uff0c\u5219\u4ee5 err \u4e3a\u62d2\u56e0\u51b3\u7edd Promise\n      return reject(err)\n    }\n\n    // \u5982\u679c then \u662f\u51fd\u6570\n    if (typeof then === 'function') {\n      let called = false\n\n      // \u5c06 x \u4f5c\u4e3a\u51fd\u6570\u4f5c\u7528\u57df this \u8c03\u7528\u4e4b\n      // \u4f20\u9012\u4e24\u4e2a\u56de\u8c03\u51fd\u6570\u4f5c\u4e3a\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u53eb\u505a resolvePromise\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u53eb\u505a rejectPromise\n      try {\n        then.call(\n          x,\n          // \u5982\u679c resolvePromise \u4ee5\u503c y \u4e3a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u5219\u8fd0\u884c [[Resolve]](promise, y)\n          function (y) {\n            // \u5982\u679c resolvePromise \u548c rejectPromise \u5747\u88ab\u8c03\u7528\n            // \u6216\u8005\u540c\u4e00\u53c2\u6570\u8c03\u7528\u591a\u6b21\uff0c\u5219\u4f18\u5148\u91c7\u7528\u9996\u6b21\u8c03\u7528\u5e76\u5ffd\u7565\u5269\u4e0b\u7684\u8c03\u7528\n            // \u5b9e\u73b0\u8fd9\u6761\u9700\u8981\u524d\u9762\u52a0\u4e00\u4e2a\u53d8\u91cf called\n            if (called) return\n            called = true\n            resolvePromise(promise, y, resolve, reject)\n          },\n          // \u5982\u679c rejectPromise \u4ee5\u62d2\u56e0 r \u4e3a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u5219\u4ee5\u62d2\u56e0 r \u62d2\u7edd promise\n          function (r) {\n            if (called) return\n            called = true\n            reject(r)\n          }\n        )\n      } catch (err) {\n        // \u5982\u679c\u8c03\u7528 then \u65b9\u6cd5\u629b\u51fa\u4e86\u5f02\u5e38 err\n        // \u5982\u679c resolvePromise \u6216 rejectPromise \u5df2\u7ecf\u88ab\u8c03\u7528\uff0c\u5219\u5ffd\u7565\u4e4b\n        if (called) return\n\n        reject(err)\n      }\n    } else {\n      // \u5982\u679c then \u4e0d\u662f\u51fd\u6570\uff0c\u4ee5 x \u53c2\u6570\u6267\u884c Promise\n      resolve(x)\n    }\n  } else {\n    // \u5982\u679c x \u4e0d\u4e3a\u5bf9\u8c61\u6216\u8005\u51fd\u6570\uff0c\u4ee5 x \u4e3a\u53c2\u6570\u6267\u884c resolve\n    resolve(x)\n  }\n}\n\nPromise.prototype.then = function (onFulfilled, onRejected) {\n  const self = this\n  const onFulfillment = typeof onFulfilled === 'function' ? onFulfilled : value => value\n  const onRejection = typeof onRejected === 'function' ? onRejected : reason => { throw reason }\n\n  let returnPromise = new Promise(function (resolve, reject) {\n\n    function handler (flag) {\n      const condition = flag === STATUS.FULFILLED ? onFulfilled : onRejected\n      const callback = flag === STATUS.FULFILLED ? onFulfillment : onRejection\n      const param = flag === STATUS.FULFILLED ? self.value : self.reason\n\n      setTimeout(function () {\n        try {\n          if (typeof condition === 'function') {\n            let x = callback(param)\n            resolvePromise(returnPromise, x, resolve, reject)\n          } else {\n            flag === STATUS.FULFILLED ? resolve(param) : reject(param)\n          }\n        } catch (err) {\n          reject(err)\n        }\n      }, 0)\n    }\n\n    if (self.status === STATUS.PENDING) {\n      // Promise \u5f53\u524d\u72b6\u6001\u8fd8\u662f Pending\uff0c\u5c06\u56de\u8c03\u51fd\u6570\u4fdd\u5b58\u8d77\u6765\n      self.onFulfilledHandlers.push(function () {\n        handler(STATUS.FULFILLED)\n      })\n      self.onRejectionHandlers.push(function () {\n        handler(STATUS.REJECTED)\n      })\n    } else if (self.status === STATUS.FULFILLED) {\n      handler(STATUS.FULFILLED)\n    } else {\n      handler(STATUS.REJECTED)\n    }\n  })\n\n  return returnPromise\n}\n\nPromise.prototype.catch = function (onRejection) {\n  this.then(null, onRejection)\n}\n\nPromise.prototype.finally = function (fn) {\n  return this.then(function (value) {\n    return Promise.resolve(fn()).then(function () {\n      return value\n    })\n  }, function (err) {\n    return Promise.reject(fn()).then(function () {\n      return err\n    })\n  })\n}\n\nPromise.resolve = function (value) {\n  if (value instanceof Promise) {\n    return value\n  }\n\n  return new Promise(function (resolve) {\n    resolve(value)\n  })\n}\n\n// \u8fd4\u56de\u6307\u5b9a reason \u5931\u8d25\u6001\u7684 Promise \u5bf9\u8c61\nPromise.reject = function (reason) {\n  return new Promise((resolve, reject) => {\n    reject(reason)\n  })\n}\n\n// \u8fd4\u56de\u4e00\u4e2a Promise \u5bf9\u8c61\uff0c\u53ea\u6709\u5f53\u6240\u6709 Promise \u90fd\u6210\u529f\u65f6\u8fd4\u56de\u7684 Promise \u72b6\u6001\u624d\u6210\u529f\nPromise.all = function (iterable) {\n  const values = new Array(iterable.length)\n  // \u72b6\u6001\u4e3a fulfilled \u7684 Promise \u7684\u6570\u91cf\n  let resolvedCount = 0\n\n  return new Promise((resolve, reject) => {\n    // \u904d\u5386 iterable\uff0c\u83b7\u53d6\u6bcf\u4e2a Promise \u7684\u7ed3\u679c\n    iterable.forEach((promise, index) => {\n      Promise.resolve(promise).then(\n        value => {\n          resolvedCount++\n          values[index] = value\n\n          // \u5982\u679c\u5168\u90e8 Promise \u90fd\u4e3a fulfilled \u72b6\u6001\uff0creturn \u7684 Promise \u72b6\u6001\u4e3a fulfilled\n          if (resolvedCount === iterable.length) {\n            resolve(values)\n          }\n        },\n        reason => {\n          // \u53ea\u8981\u6709\u4e00\u4e2a\u5931\u8d25\uff0creturn \u7684 Promise \u72b6\u6001\u5c31\u4e3a reject\n          reject(reason)\n        }\n      )\n    })\n  })\n}\n\n// \u8fd4\u56de\u4e00\u4e2a Promise \u5bf9\u8c61\uff0c\nPromise.race = function (iterable) {\n  return new Promise((resolve, reject) => {\n    // \u904d\u5386\u6570\u7ec4\uff0c\u83b7\u53d6\u6bcf\u4e2a Promise \u7684\u7ed3\u679c\n    iterable.forEach((item, index) => {\n      Promise.resolve(item).then(\n        value => {\n          resolve(value)\n        },\n        reason => {\n          reject(reason)\n        }\n      )\n    })\n  })\n}\n\nPromise.allSettled = function (iterable) {\n  return new Promise(function (resolve, reject) {\n    const len = iterable.length\n    let result = []\n    let resolveCount = 0\n\n    if (length === 0) {\n      return resolve(result)\n    } else {\n      for (let i = 0; i < len; i++) {\n        (function (i) {\n          const currentPromise = Promise.resolve(iterable[i])\n\n          currentPromise.then(function (value) {\n            resolveCount++\n            result[i] = {\n              status: STATUS.FULFILLED,\n              value: value\n            }\n\n            if (resolveCount === len) {\n              return resolve(result)\n            }\n          }, function (reason) {\n            resolveCount++\n            result[i] = {\n              status: STATUS.REJECTED,\n              reason: reason\n            }\n            if (count === len) {\n              return resolve(result)\n            }\n          })\n        })(i)\n      }\n    }\n  })\n}\n\nPromise.deferred = function () {\n  var result = {}\n\n  result.promise = new Promise(function (resolve, reject) {\n    result.resolve = resolve\n    result.reject = reject\n  })\n\n  return result\n}\n\nmodule.exports = Promise\n\n",lang:"js"}),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("a",{href:"https://juejin.im/post/5e8bec156fb9a03c4d40f4bc",target:"_blank",rel:"noopener noreferrer"},"\u624b\u5199\u4e00\u4e2a Promise/A+\uff0c\u5b8c\u7f8e\u901a\u8fc7\u5b98\u65b9 872 \u4e2a\u6d4b\u8bd5\u7528\u4f8b",l.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0,x:"0px",y:"0px",viewBox:"0 0 100 100",width:"15",height:"15",className:"__dumi-default-external-link-icon"},l.a.createElement("path",{fill:"currentColor",d:"M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"}),l.a.createElement("polygon",{fill:"currentColor",points:"45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"})))))))}}}]);